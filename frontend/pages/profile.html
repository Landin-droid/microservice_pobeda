<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="icon" type="image/png" href="../forFavicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="../forFavicon/favicon.svg" />
    <link rel="shortcut icon" href="../forFavicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="../forFavicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Pobeda" />
    <link rel="manifest" href="../forFavicon/site.webmanifest" />

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .forms-h2 {
        font-size: 24px;
        margin-bottom: 20px;
        }
        .profile-h3 {
        font-size: 18px;
        margin: 15px 0;
        }
        input {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        }
        .show-register, .show-login {
        background: none;
        color: #007bff;
        border: none;
        padding: 0;
        font-size: 14px;
        }
        .login-no-account-p, .register-no-account-p {
        margin-top: 10px;
        font-size: 14px;
        }
        .hidden {
        display: none;
        }
        .booking__container {
        margin-top: 20px;
        }
        #bookings-list {
        list-style: none;
        padding: 0;
        }
        .booking-item {
        background: #f0f0f0;
        border: 1px solid #8abdff;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        }
        .booking-item button {
        background-color: #dc3545;
        width: auto;
        padding: 5px 10px;
        border-radius: 5px;
        }
        .booking-item button:hover {
        background-color: #c82333;
        }
        .error {
        color: red;
        font-size: 14px;
        text-align: center;
        margin-top: 10px;
        }
        .success {
        color: green;
        font-size: 14px;
        text-align: center;
        margin-top: 10px;
        }
        .admin-section {
      margin-top: 20px;
    }
    .admin-section table {
      width: 100%;
      border-collapse: collapse;
    }
    .admin-section th, .admin-section td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .admin-section th {
      background-color: #f2f2f2;
    }
    .admin-section select {
      padding: 5px;
    }
    .admin-section .btn {
      margin: 0 5px;
    }
    .checkbox-group {
      margin-bottom: 15px;
    }
    .checkbox-group label {
      margin-right: 20px;
    }
    @media (max-width: 600px) {
      .container__main1 {
        padding: 15px;
      }
      .forms-h2 {
        font-size: 20px;
      }
      .profile-h3 {
        font-size: 16px;
      }
      .admin-section table {
        font-size: 14px;
      }
    }
    </style>
    <link rel="stylesheet" href="../css/profileStyle.css">
</head>
<body>
    <header class="header">
        <div class="container__header">
            <div class="header__body">
                <a href="../index.html" class="header__logo">
                    <img src="../images/логоДомик.jpg" alt="Логотип базы отдыха" title="Логотип базы отдыха">
                </a>
                <div class="header__burger">
                    <span></span>
                </div>
                <nav class="header__menu">
                    <ul class="header__list">
                        <li><a href="../index.html" class="header__link slick-element">Главная</a></li>
                        <li><a href="../pages/rent.html" class="header__link slick-element">Прокат</a></li>
                        <li><a href="../pages/book.html" class="header__link slick-element">Бронирование</a></li>
                        <li><a href="../pages/cafe.html" class="header__link slick-element">Кафе</a></li>
                        <li><a href="../pages/karaoke.html" class="header__link slick-element">Караоке-бар</a></li>
                        <li><a href="../pages/profile.html" class="header__link slick-element">Личный кабинет</a></li>
                    </ul>
                    <div class="worktime hburger-active">
                        Время работы: 9:00 – 23:00
                    </div>
                    <a class="workphone hburger-active" href="tel:+71234567890">
                        +7-123-456-78-90
                    </a>
                </nav>
                <div class="grid__works">
                    <div class="header__workphone">
                        Время работы:
                    </div>
                    <div class="header__worktime">
                        9:00 – 23:00
                    </div>
                </div>
            </div>
        </div>
    </header>
    <main class="main__content">
        <div class="container__main1">

            <!-- Форма входа -->
            <div id="login-form">
                <h2 class="forms-h2">Вход</h2>
                <input type="email" id="login-email" placeholder="Email">
                <input type="password" id="login-password" placeholder="Пароль">
                <button id="login-btn" class="btn">Войти</button>
                <p id="login-message" class="error"></p>
                <p class="login-no-account-p">Нет аккаунта?
                    <a href="#" id="show-register"><button class="show-register">Зарегистрироваться</button></a>
                </p>
            </div>

            <!-- Форма регистрации -->
            <div id="register-form" class="hidden">
                <h2 class="forms-h2">Регистрация</h2>
                <input type="text" id="register-name" placeholder="Имя">
                <input type="text" id="register-surname" placeholder="Фамилия">
                <input type="email" id="register-email" placeholder="Email">
                <input type="tel" id="register-phone" placeholder="Телефон (+79991234567)">
                <input type="password" id="register-password" placeholder="Пароль">
                <button id="register-btn" class="btn">Зарегистрироваться</button>
                <p id="register-message" class="error"></p>
                <p class="register-no-account-p">Уже есть аккаунт?
                    <a href="#" id="show-login"><button class="show-login">Войти</button></a>
                </p>
            </div>

            <!-- Личный кабинет -->
            <div id="welcome" class="hidden">
                <h2 class="forms-h2">Добро пожаловать, <span id="user-name">Пользователь</span>!</h2>
                <p class="email-welcome">Ваш email: <span id="user-email"></span></p>
                <div id="admin-section" class="hidden admin-section">
                  <h3 class="profile-h3">Админ-панель</h3>
                  <h4>Управление бронированиями</h4>
                  <table>
                    <thead>
                      <tr>
                        <th>Пользователь</th>
                        <th>Объект</th>
                        <th>Дата</th>
                        <th>Статус</th>
                        <th>Цена</th>
                        <th>Человек</th>
                        <th>Действия</th>
                      </tr>
                    </thead>
                    <tbody id="all-bookings-table"></tbody>
                  </table>
                  <h4>Управление домиками и беседками</h4>
                  <button id="add-item-btn" class="btn">Добавить объект</button>
                  <div id="add-item-form" class="hidden">
                    <h5>Добавить/редактировать объект</h5>
                    <select id="item-type" onchange="toggleItemFields()">
                      <option value="house">Домик</option>
                      <option value="gazebo">Беседка</option>
                    </select>
                    <input type="text" id="item-name" placeholder="Название">
                    <input type="number" id="item-price" placeholder="Цена (руб)" step="0.01">
                    <input type="number" id="item-people-amount" placeholder="Количество человек">
                    <div id="house-fields" class="checkbox-group">
                      <label><input type="checkbox" id="house-water-supply"> Водоснабжение</label>
                      <label><input type="checkbox" id="house-electricity"> Электричество</label>
                      <label><input type="checkbox" id="house-bathroom"> Ванная</label>
                      <label><input type="checkbox" id="house-fridge"> Холодильник</label>
                      <label><input type="checkbox" id="house-teapot"> Чайник</label>
                      <label><input type="checkbox" id="house-microwave-oven"> Микроволновка</label>
                    </div>
                    <div id="gazebo-fields" class="checkbox-group hidden">
                      <label><input type="checkbox" id="gazebo-electricity"> Электричество</label>
                      <label><input type="checkbox" id="gazebo-grill"> Гриль</label>
                    </div>
                    <textarea id="item-images" placeholder='Массив URL-ов изображений, например: ["image1.jpg", "image2.jpg"]'></textarea>
                    <button id="save-item-btn" class="btn">Сохранить</button>
                    <p id="add-item-message" class="error"></p>
                  </div>
                  <ul id="items-list"></ul>
                </div>
                <button id="edit-profile-btn" class="btn">Редактировать профиль</button>
                <div id="edit-profile-form" class="hidden">
                    <h3 class="profile-h3 edit-title-h3">Редактировать профиль</h3>
                    <input type="text" id="edit-name" placeholder="Имя">
                    <input type="text" id="edit-surname" placeholder="Фамилия">
                    <input type="email" id="edit-email" placeholder="Email">
                    <input type="tel" id="edit-phone" placeholder="Телефон (+79991234567)">
                    <button id="save-profile-btn" class="btn">Сохранить изменения</button>
                    <p id="edit-message" class="error"></p>
                </div>
                <div class="booking__container">
                    <h3 class="profile-h3">Ваши бронирования:</h3>
                    <ul id="bookings-list">
                        <!-- Список бронирований -->
                    </ul>
                    <h3 class="profile-h3" id="total-sum">Итоговая сумма: 0 руб.</h3>
                </div>
                <button id="pay-button" class="btn hidden">Перейти к оплате</button>
                <button id="booking-page-btn" class="btn">Перейти к бронированию</button>
                <button id="logout-btn" class="btn">Выйти</button>
            </div>
        </div>
    </main>
    <footer class="footer">
        <div class="container__main footer__container">
            <!-- <ul class="footer__menu">
                <li class="footer__menu-item"><a href="./pages/rent.html" class="footer__menu-link">Прокат</a></li>
                <li class="footer__menu-item"><a href="./pages/book.html" class="footer__menu-link">Бронирование</a></li>
                <li class="footer__menu-item"><a href="./pages/cafe.html" class="footer__menu-link">Кафе</a></li>
                <li class="footer__menu-item"><a href="./pages/karaoke.html" class="footer__menu-link">Караоке-бар</a></li>
                <li class="footer__menu-item"><a href="./pages/profile.html" class="footer__menu-link">Личный кабинет</a></li>
            </ul> -->
            <div class="footer__wrapper">
                <div class="footer__contacts">
                    <div class="footer__contacts-item footer__contacts-item--address">
                        <div class="footer__contacts-address-container">
                            <div class="footer__contacts-address">
                                <span class="visually-hidden">Адрес:</span>
                                <span class='material-icons gps_fixed'>gps_fixed</span>
                                652470, 
                                <span class="text-address">Кемеровская область - Кузбасс,</span>
                                <span class="text-address">г. Анжеро-Судженск,</span>
                                <span class="text-address">начало ул. Хвойной,</span>
                                <span class="text-address"></span>
                            </div>
                            <div class="footer__contacts-coords">
                                <span class="visually-hidden">Координаты:</span>
                                <a href="https://yandex.ru/maps/-/CHEiVRjq" class="footer__contacts-link" rel="noopener nofollow" target="_blank">56.074652, 85.971829</a>
                            </div>
                        </div>
                    </div>
                    <div class="footer__contacts-item footer__contacts-item--phone">
                        <div class="footer__contacts-phone">
                            <span class='material-icons smartphone-icon'>smartphone</span>
                            <a href="tel:+71234567890" class="footer__contacts-link" target="_blank">+7 123 456 78 90</a>
                        </div>
                    </div>
                    <div class="footer__contacts-item footer__contacts-item--email">
                        <span class='material-icons email-icon'>email</span>
                        <a href="mailto:info@pobedabase.ru" class="footer__contacts-link" target="_blank">info@pobedabase.ru</a>
                        <div class="footer__socials">
                            <a href="https://vk.com/b.pobeda" class="social__item icon-vk" 
                            target="_blank" rel="noreferrer" aria-label="Ссылка на группу во Вконтакте">
                                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="30" width="30" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M545 117.7c3.7-12.5 0-21.7-17.8-21.7h-58.9c-15 0-21.9 7.9-25.6 16.7 0 0-30 73.1-72.4 120.5-13.7 13.7-20 18.1-27.5 18.1-3.7 
                                    0-9.4-4.4-9.4-16.9V117.7c0-15-4.2-21.7-16.6-21.7h-92.6c-9.4 0-15 7-15 13.5 0 14.2 21.2 17.5 23.4 57.5v86.8c0 19-3.4 22.5-10.9 22.5-20 
                                    0-68.6-73.4-97.4-157.4-5.8-16.3-11.5-22.9-26.6-22.9H38.8c-16.8 0-20.2 7.9-20.2 16.7 0 15.6 20 93.1 93.1 195.5C160.4 378.1 229 416 291.4 
                                    416c37.5 0 42.1-8.4 42.1-22.9 0-66.8-3.4-73.1 15.4-73.1 8.7 0 23.7 4.4 58.7 38.1 40 40 46.6 57.9 69 57.9h58.9c16.8 0 25.3-8.4 
                                    20.4-25-11.2-34.9-86.9-106.7-90.3-111.5-8.7-11.2-6.2-16.2 0-26.2.1-.1 72-101.3 79.4-135.6z"></path>
                                </svg>
                            </a>
                            <a href="https://m.ok.ru/profile/572263020828?__dp=y" class="social__item icon-ok" 
                            target="_blank" rel="noreferrer" aria-label="Ссылка на группу в Одноклассниках">
                                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 320 512" height="26" width="26" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M275.1 334c-27.4 17.4-65.1 24.3-90 26.9l20.9 20.6 76.3 76.3c27.9 28.6-17.5 73.3-45.7 45.7-19.1-19.4-47.1-47.4-76.3-76.6L84 
                                    503.4c-28.2 27.5-73.6-17.6-45.4-45.7 19.4-19.4 47.1-47.4 76.3-76.3l20.6-20.6c-24.6-2.6-62.9-9.1-90.6-26.9-32.6-21-46.9-33.3-34.3-59 
                                    7.4-14.6 27.7-26.9 54.6-5.7 0 0 36.3 28.9 94.9 28.9s94.9-28.9 94.9-28.9c26.9-21.1 47.1-8.9 54.6 5.7 12.4 25.7-1.9 38-34.5 59.1zM30.3 
                                    129.7C30.3 58 88.6 0 160 0s129.7 58 129.7 129.7c0 71.4-58.3 129.4-129.7 129.4s-129.7-58-129.7-129.4zm66 0c0 35.1 28.6 63.7 63.7 
                                    63.7s63.7-28.6 63.7-63.7c0-35.4-28.6-64-63.7-64s-63.7 28.6-63.7 64z"></path>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer__copyright__container">
                <div class="footer__copyright-text">
                    © 2024. База отдыха «Победа»
                    <span class="text-official">Официальный сайт.</span>
                </div>
            </div>
            <div class="footer__payments">
                <div class="footer__payments-list">
                    <div class="footer__payments-item">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/d/d6/Visa_2021.svg" 
                        alt="Логотип Visa" class="footer__payments-image" width="90" height="50" loading="lazy">
                    </div>
                    <div class="footer__payments-item icon-mir__item">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b9/Mir-logo.SVG.svg" 
                        alt="Логотип Мир" class="footer__payments-image" width="90" height="50" loading="lazy">
                    </div>
                    <div class="footer__payments-item">
                        <img src="https://cdn.tbank.ru/static/pfa-multimedia/images/ed62434c-f486-441f-9545-767dc7a3303a.svg" 
                        alt="Логотип Т-Банк" class="footer__payments-image" width="90" height="50" loading="lazy">
                    </div>
                    <div class="footer__payments-item">
                        <img src="https://upload.wikimedia.org/wikipedia/ru/c/c7/СБП_логотип.svg" 
                        alt="Логотип СБП" class="footer__payments-image" width="90" height="50" loading="lazy">
                    </div>
                    <div class="footer__payments-item">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/SberPay.png" 
                        alt="Логотип SberPay" class="footer__payments-image" width="90" height="50" loading="lazy">
                    </div>
                    <div class="footer__payments-item">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/1/1b/UnionPay_logo.svg" 
                        alt="Логотип UnionPay" class="footer__payments-image" width="90" height="50" loading="lazy">
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script>
      const API_URL = {
        auth: 'https://auth-service-g23m.onrender.com',
        booking: 'https://booking-service-g1ea.onrender.com',
        admin: 'https://booking-admin-service.onrender.com'
      };
      // Кэш для домиков и беседок
      let itemsCache = { houses: {}, gazebos: {} };
      // Показ/скрытие форм
      document.getElementById('show-register').addEventListener('click', () => {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-form').classList.remove('hidden');
    });

      document.getElementById('show-login').addEventListener('click', () => {
      document.getElementById('register-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
    });

      document.getElementById('edit-profile-btn').addEventListener('click', () => {
      document.getElementById('edit-profile-form').classList.toggle('hidden');
    });


    function resetItemForm() {
      document.getElementById('item-type').value = 'house';
      document.getElementById('item-type').disabled = false;
      document.getElementById('item-name').value = '';
      document.getElementById('item-price').value = '';
      document.getElementById('item-people-amount').value = '';
      document.getElementById('item-images').value = '';
      document.getElementById('house-water-supply').checked = false;
      document.getElementById('house-electricity').checked = false;
      document.getElementById('house-bathroom').checked = false;
      document.getElementById('house-fridge').checked = false;
      document.getElementById('house-teapot').checked = false;
      document.getElementById('house-microwave-oven').checked = false;
      document.getElementById('gazebo-electricity').checked = false;
      document.getElementById('gazebo-grill').checked = false;
      document.getElementById('save-item-btn').textContent = 'Сохранить';
      document.getElementById('save-item-btn').onclick = saveItem;
      document.getElementById('add-item-message').textContent = '';
      toggleItemFields();
    }

    function toggleItemFields() {
      const type = document.getElementById('item-type').value;
      document.getElementById('house-fields').classList.toggle('hidden', type !== 'house');
      document.getElementById('gazebo-fields').classList.toggle('hidden', type !== 'gazebo');
    }

    // Проверка авторизации
    document.addEventListener('DOMContentLoaded', async () => {
      const token = Cookies.get('jwt_token');
      if (token) {
        try {
          const user = await getUserProfile(token);
          document.getElementById('login-form').classList.add('hidden');
          document.getElementById('register-form').classList.add('hidden');
          document.getElementById('welcome').classList.remove('hidden');
          document.getElementById('user-name').textContent = `${user.name} ${user.surname}`;
          document.getElementById('user-email').textContent = user.email;
          if (user.role === 'admin') {
            document.getElementById('admin-section').classList.remove('hidden');
            await loadItemsCache();
            fetchAllBookings();
            fetchAllItems();
          }
          await loadItemsCache();
          fetchBookings();
        } catch (error) {
          console.error('Invalid token:', error);
        }
      }
    });

    // Загрузка кэша домиков и беседок
    async function loadItemsCache() {
      try {
        const [housesResponse, gazebosResponse] = await Promise.all([
          fetch(`${API_URL.admin}/houses`),
          fetch(`${API_URL.admin}/gazebos`)
        ]);
        const houses = await housesResponse.json();
        const gazebos = await gazebosResponse.json();
        console.log(houses);
        if (!housesResponse.ok || !gazebosResponse.ok) throw new Error('Ошибка загрузки данных');
        houses.forEach(house => itemsCache.houses[house.id] = house);
        gazebos.forEach(gazebo => itemsCache.gazebos[gazebo.id] = gazebo);
      } catch (error) {
        console.error('Error loading items cache:', error);
      }
    }

    // Получение профиля
    async function getUserProfile(token) {
      const response = await fetch(`${API_URL.auth}/profile`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });
      if (!response.ok) throw new Error('Ошибка получения профиля');
      return await response.json();
    }

    // Регистрация
    document.getElementById('register-btn').addEventListener('click', async () => {
      const name = document.getElementById('register-name').value;
      const surname = document.getElementById('register-surname').value;
      const email = document.getElementById('register-email').value;
      const phone = document.getElementById('register-phone').value;
      const password = document.getElementById('register-password').value;
      const messageEl = document.getElementById('register-message');

      try {
        const response = await fetch(`${API_URL.auth}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, surname, email, phone, password })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Ошибка регистрации');
        messageEl.textContent = 'Регистрация успешна! Теперь войдите.';
        messageEl.className = 'success';
        document.getElementById('register-name').value = '';
        document.getElementById('register-surname').value = '';
        document.getElementById('register-email').value = '';
        document.getElementById('register-phone').value = '';
        document.getElementById('register-password').value = '';
        setTimeout(() => {
          messageEl.textContent = '';
          document.getElementById('register-form').classList.add('hidden');
          document.getElementById('login-form').classList.remove('hidden');
        }, 2000);
      } catch (error) {
        messageEl.textContent = error.message;
        messageEl.className = 'error';
      }
    });

    // Вход
    document.getElementById('login-btn').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const messageEl = document.getElementById('login-message');

      try {
        const response = await fetch(`${API_URL.auth}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Ошибка входа');
        Cookies.set('jwt_token', data.token, { expires: 7, secure: true, sameSite: 'Strict' });
        const user = await getUserProfile(data.token);
        messageEl.textContent = 'Вход успешен!';
        messageEl.className = 'success';
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('welcome').classList.remove('hidden');
        document.getElementById('user-name').textContent = `${user.name} ${user.surname}`;
        document.getElementById('user-email').textContent = user.email;
        if (user.role === 'admin') {
          document.getElementById('admin-section').classList.remove('hidden');
        }
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
        fetchBookings();
      } catch (error) {
        messageEl.textContent = error.message;
        messageEl.className = 'error';
      }
    });

    // Редактирование профиля
    document.getElementById('save-profile-btn').addEventListener('click', async () => {
      const name = document.getElementById('edit-name').value;
      const surname = document.getElementById('edit-surname').value;
      const email = document.getElementById('edit-email').value;
      const phone = document.getElementById('edit-phone').value;
      const messageEl = document.getElementById('edit-message');
      const token = Cookies.get('jwt_token');

      try {
        const response = await fetch(`${API_URL.auth}/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ name, surname, email, phone })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Ошибка обновления профиля');
        messageEl.textContent = 'Профиль обновлён!';
        messageEl.className = 'success';
        document.getElementById('user-name').textContent = `${name} ${surname}`;
        document.getElementById('user-email').textContent = email;
        document.getElementById('edit-profile-form').classList.add('hidden');
        setTimeout(() => (messageEl.textContent = ''), 2000);
      } catch (error) {
        messageEl.textContent = error.message;
        messageEl.className = 'error';
      }
    });

    // Получение бронирований
    async function fetchBookings() {
      const token = Cookies.get('jwt_token');
      if (!token) {
        alert('Пожалуйста, войдите в систему');
        logout();
        return;
      }

      try {
        const response = await fetch(`${API_URL.booking}/bookings`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        const bookings = await response.json();
        if (!response.ok) throw new Error(bookings.error || 'Ошибка получения бронирований');
        displayBookings(bookings);
      } catch (error) {
        alert('Ошибка: ' + error.message);
        logout();
      }
    }

    function displayBookings(bookings) {
      const list = document.getElementById('bookings-list');
      const totalSumEl = document.getElementById('total-sum');
      list.innerHTML = '';
      let totalSum = 0;

      for (const booking of bookings) {
        const itemId = booking.type === 'house' ? booking.house_id : booking.gazebo_id;
        const item = itemsCache[booking.type + 's'][itemId] || { name: 'Неизвестно', price: 0 };
        const price = Number(item.price) || 0;
        if (booking.status !== 'cancelled') totalSum += price;

        const li = document.createElement('li');
        li.className = 'booking-item';
        li.innerHTML = `
          <div class="booking-info">
            <div class="booking-name">${booking.type === 'house' ? 'Домик' : 'Беседка'}: ${item.name}</div>
            <div class="booking-price">Цена: ${price} руб.</div>
            <div class="booking-date">Дата: ${booking.booking_date.substring(0, 10)}</div>
            <div class="booking-status">Статус: ${
              booking.status === 'pending' ? 'Ожидает' : booking.status === 'confirmed' ? 'Подтверждено' : 'Отменено'}
            </div>
          </div>
          ${booking.status !== 'cancelled' ? `<button onclick="cancelBooking(${booking.id})">Отменить</button>` : ''}
        `;
        list.appendChild(li);
      }

      totalSumEl.textContent = `Итоговая сумма: ${totalSum} руб.`;
      document.getElementById('pay-button').classList.toggle('hidden', totalSum === 0 || bookings.every(b => b.status === 'cancelled'));
    }

    // Отмена бронирования
    async function cancelBooking(bookingId) {
      const token = Cookies.get('jwt_token');
      if (!token) {
        alert('Пожалуйста, войдите в систему');
        logout();
        return;
      }

      if (!confirm('Вы уверены, что хотите отменить бронирование?')) return;

      try {
        const response = await fetch(`${API_URL.booking}/bookings/${bookingId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Ошибка отмены');
        alert('Бронирование отменено');
        fetchBookings();
      } catch (error) {
        alert('Ошибка: ' + error.message);
      }
    }

    async function fetchAllBookings() {
      const token = Cookies.get('jwt_token');
      try {
        const response = await fetch(`${API_URL.booking}/bookings/all`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        const bookings = await response.json();
        if (!response.ok) throw new Error(bookings.error || 'Ошибка получения бронирований');
        displayAllBookings(bookings);
      } catch (error) {
        console.error('Error fetching all bookings:', error);
        document.getElementById('all-bookings-table').innerHTML = '<tr><td colspan="7">Ошибка загрузки</td></tr>';
      }
    }

    function displayAllBookings(bookings) {
      const tableBody = document.getElementById('all-bookings-table');
      tableBody.innerHTML = '';
      for (const booking of bookings) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${booking.email}</td>
          <td>${booking.type === 'house' ? 'Домик' : 'Беседка'}: ${booking.item_name}</td>
          <td>${booking.booking_date}</td>
          <td>
            <select onchange="updateBookingStatus(${booking.id}, this.value)">
              <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Ожидает</option>
              <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Подтверждено</option>
              <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Отменено</option>
            </select>
          </td>
          <td>${booking.item_price} руб.</td>
          <td>${booking.item_people_amount}</td>
          <td>
            <button class="btn btn-danger" onclick="deleteBooking(${booking.id})">Удалить</button>
          </td>
        `;
        tableBody.appendChild(tr);
      }
    }

    async function updateBookingStatus(bookingId, status) {
      const token = Cookies.get('jwt_token');
      try {
        const response = await fetch(`${API_URL.booking}/bookings/${bookingId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ status })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Ошибка обновления статуса');
        alert('Статус обновлён');
        fetchAllBookings();
      } catch (error) {
        alert('Ошибка: ' + error.message);
        fetchAllBookings();
      }
    }

    async function deleteBooking(bookingId) {
      if (!confirm('Вы уверены, что хотите удалить бронирование?')) return;
      const token = Cookies.get('jwt_token');
      try {
        const response = await fetch(`${API_URL.booking}/bookings/${bookingId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Ошибка удаления');
        alert('Бронирование удалено');
        fetchAllBookings();
      } catch (error) {
        alert('Ошибка: ' + error.message);
      }
    }

    async function fetchAllItems() {
      try {
        const [housesResponse, gazebosResponse] = await Promise.all([
          fetch(`${API_URL.admin}/houses`),
          fetch(`${API_URL.admin}/gazebos`)
        ]);
        const houses = await housesResponse.json();
        const gazebos = await gazebosResponse.json();
        if (!housesResponse.ok || !gazebosResponse.ok) throw new Error('Ошибка загрузки объектов');
        displayItems([...houses.map(h => ({ ...h, type: 'house' })), ...gazebos.map(g => ({ ...g, type: 'gazebo' }))]);
      } catch (error) {
        console.error('Error fetching items:', error);
      }
    }

    function displayItems(items) {
      const list = document.getElementById('items-list');
      list.innerHTML = '';
      for (const item of items) {
        const amenities = item.type === 'house'
          ? `Вода: ${item.water_supply ? 'Да' : 'Нет'}, Электричество: ${item.electricity ? 'Да' : 'Нет'}, Ванная: ${item.bathroom ? 'Да' : 'Нет'}, Холодильник: ${item.fridge ? 'Да' : 'Нет'}, Чайник: ${item.teapot ? 'Да' : 'Нет'}, Микроволновка: ${item.microwave_oven ? 'Да' : 'Нет'}`
          : `Электричество: ${item.electricity ? 'Да' : 'Нет'}, Гриль: ${item.grill ? 'Да' : 'Нет'}`;
        const li = document.createElement('li');
        li.className = 'item';
        li.innerHTML = `
          <span>${item.type === 'house' ? 'Домик' : 'Беседка'}: ${item.name}, Цена: ${item.price} руб., Человек: ${item.people_amount}, ${amenities}</span>
          <button class="btn btn-warning" onclick='editItem("${item.type}", ${item.id}, ${JSON.stringify(item)})'>Редактировать</button>
          <button class="btn btn-danger" onclick="deleteItem('${item.type}', ${item.id})">Удалить</button>
        `;
        list.appendChild(li);
      }
    }

    async function saveItem() {
      const type = document.getElementById('item-type').value;
      const name = document.getElementById('item-name').value;
      const price = document.getElementById('item-price').value;
      const people_amount = document.getElementById('item-people-amount').value;
      let images;
      try {
        images = JSON.parse(document.getElementById('item-images').value || '[]');
      } catch (e) {
        document.getElementById('add-item-message').textContent = 'Некорректный JSON в поле изображений';
        document.getElementById('add-item-message').className = 'error';
        return;
      }
      const body = { name, price: parseFloat(price), people_amount: parseInt(people_amount), images };
      if (type === 'house') {
        body.water_supply = document.getElementById('house-water-supply').checked;
        body.electricity = document.getElementById('house-electricity').checked;
        body.bathroom = document.getElementById('house-bathroom').checked;
        body.fridge = document.getElementById('house-fridge').checked;
        body.teapot = document.getElementById('house-teapot').checked;
        body.microwave_oven = document.getElementById('house-microwave-oven').checked;
      } else {
        body.electricity = document.getElementById('gazebo-electricity').checked;
        body.grill = document.getElementById('gazebo-grill').checked;
      }
      const token = Cookies.get('jwt_token');
      const messageEl = document.getElementById('add-item-message');

      try {
        const response = await fetch(`${API_URL.admin}/${type}s`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(body)
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Ошибка создания объекта');
        messageEl.textContent = 'Объект создан!';
        messageEl.className = 'success';
        document.getElementById('add-item-form').classList.add('hidden');
        resetItemForm();
        await loadItemsCache();
        fetchAllItems();
      } catch (error) {
        messageEl.textContent = error.message;
        messageEl.className = 'error';
      }
    }

    document.getElementById('save-item-btn').addEventListener('click', saveItem);

    function editItem(type, id, item) {
      document.getElementById('add-item-form').classList.remove('hidden');
      document.getElementById('item-type').value = type;
      document.getElementById('item-type').disabled = true;
      document.getElementById('item-name').value = item.name;
      document.getElementById('item-price').value = item.price;
      document.getElementById('item-people-amount').value = item.people_amount;
      document.getElementById('item-images').value = JSON.stringify(item.images || []);

      // Убедись, что images — массив, и сериализуй его корректно
      document.getElementById('item-images').value = JSON.stringify(item.images || [], null, 2);

      if (type === 'house') {
        document.getElementById('house-water-supply').checked = item.water_supply;
        document.getElementById('house-electricity').checked = item.electricity;
        document.getElementById('house-bathroom').checked = item.bathroom;
        document.getElementById('house-fridge').checked = item.fridge;
        document.getElementById('house-teapot').checked = item.teapot;
        document.getElementById('house-microwave-oven').checked = item.microwave_oven;
      } else {
        document.getElementById('gazebo-electricity').checked = item.electricity;
        document.getElementById('gazebo-grill').checked = item.grill;
      }
      toggleItemFields();
      document.getElementById('save-item-btn').textContent = 'Обновить';
      document.getElementById('save-item-btn').onclick = async () => {
        const token = Cookies.get('jwt_token');
        const messageEl = document.getElementById('add-item-message');
        const imagesInput = document.getElementById('item-images').value.trim();
        let images;
        try {
          images = imagesInput ? JSON.parse(imagesInput) : [];
          // Убедись, что images — массив строк
          if (!Array.isArray(images) || images.some(img => typeof img !== 'string')) {
            throw new Error('Поле изображений должно быть массивом строк');
          }
        } catch (e) {
          messageEl.textContent = 'Некорректный JSON в поле изображений';
          messageEl.className = 'error';
          return;
        }
        const body = {
          name: document.getElementById('item-name').value,
          price: parseFloat(document.getElementById('item-price').value),
          people_amount: parseInt(document.getElementById('item-people-amount').value),
          images
        };
        if (type === 'house') {
          body.water_supply = document.getElementById('house-water-supply').checked;
          body.electricity = document.getElementById('house-electricity').checked;
          body.bathroom = document.getElementById('house-bathroom').checked;
          body.fridge = document.getElementById('house-fridge').checked;
          body.teapot = document.getElementById('house-teapot').checked;
          body.microwave_oven = document.getElementById('house-microwave-oven').checked;
        } else {
          body.electricity = document.getElementById('gazebo-electricity').checked;
          body.grill = document.getElementById('gazebo-grill').checked;
        }

        // Валидация остальных полей
        if (!body.name || isNaN(body.price) || isNaN(body.people_amount)) {
          messageEl.textContent = 'Заполните все обязательные поля (название, цена, количество человек)';
          messageEl.className = 'error';
          return;
        }

        try {
          const response = await fetch(`${API_URL.admin}/${type}s/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(body)
          });

          const data = await response.json();
          if (!response.ok) throw new Error(data.error || 'Ошибка обновления объекта');
          messageEl.textContent = 'Объект обновлён!';
          messageEl.className = 'success';
          document.getElementById('add-item-form').classList.add('hidden');
          document.getElementById('item-type').disabled = false;
          document.getElementById('save-item-btn').textContent = 'Сохранить';
          document.getElementById('save-item-btn').onclick = saveItem;
          resetItemForm();
          await loadItemsCache();
          fetchAllItems();
        } catch (error) {
          messageEl.textContent = error.message;
          messageEl.className = 'error';
        }
      };
    }

    async function deleteItem(type, id) {
      if (!confirm('Вы уверены, что хотите удалить объект?')) return;
      const token = Cookies.get('jwt_token');
      try {
        const response = await fetch(`${API_URL.admin}/${type}s/${id}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Ошибка удаления объекта');
        alert('Объект удалён');
        await loadItemsCache();
        fetchAllItems();
      } catch (error) {
        alert('Ошибка: ' + error.message);
      }
    }

    // Выход
    document.getElementById('logout-btn').addEventListener('click', () => {
      logout();
    });

    function logout() {
      Cookies.remove('jwt_token');
      document.getElementById('welcome').classList.add('hidden');
      document.getElementById('admin-section').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('bookings-list').innerHTML = '';
      document.getElementById('total-sum').textContent = 'Итоговая сумма: 0 руб.';
      document.getElementById('pay-button').classList.add('hidden');
    }

    // Переход к бронированию
    document.getElementById('booking-page-btn').addEventListener('click', () => {
      window.location.href = '/pages/book.html';
    });

    // Загрузка данных в форму редактирования
    document.getElementById('edit-profile-btn').addEventListener('click', async () => {
      const token = Cookies.get('jwt_token');
      try {
        const user = await getUserProfile(token);
        document.getElementById('edit-name').value = user.name;
        document.getElementById('edit-surname').value = user.surname;
        document.getElementById('edit-email').value = user.email;
        document.getElementById('edit-phone').value = user.phone;
      } catch (error) {
        console.error('Error loading profile:', error);
      }
    });
    </script>

</body>
</html>